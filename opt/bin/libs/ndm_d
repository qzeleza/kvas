#!/bin/sh
. /opt/apps/kvas/bin/libs/ndm
# ------------------------------------------------------------------------------------------
#
# 	ПРОЕКТ КВАС
#
# ------------------------------------------------------------------------------------------
# 	Данный файл служит основной библиотекой функций пакета КВАС
# ------------------------------------------------------------------------------------------
#	Разработчик: kvas@zeleza.ru
#	Дата: 18/01/2024
#	Лицензия: Apache License 2.0
# ------------------------------------------------------------------------------------------
iface_file=/opt/etc/inface_equals

# ------------------------------------------------------------------------------------------
#
# Получаем конкретный или все интерфейсы роутера в json формате
#
# Передаем имя конкретного CLI интерфейса роутера,
# или ключевое слово all или ALL - для всех интерфейсов
#
# ------------------------------------------------------------------------------------------
get_cli_iface_json(){

    cli_iface="${1:-all}"

    echo "${cli_iface}" | grep -i all && cli_iface=''
    curl -s localhost:79/rci/show/interface/"${cli_iface}"
}
# ------------------------------------------------------------------------------------------
#
# Получаем название конкретного интерфейса
#
# Передаем имя конкретного CLI интерфейса роутера
#
# ------------------------------------------------------------------------------------------
get_iface_description(){
	cli_iface=${1}
    get_cli_iface_json "${cli_iface}" | jq 'description'
}
# ------------------------------------------------------------------------------------------
#
# Проверяем название конкретного интерфейса на то,
# является ли он глобальным интерфейсом - необходим ли он для подключения к провайдеру.
#
# Передаем имя конкретного CLI интерфейса роутера
#
# ------------------------------------------------------------------------------------------
is_cli_iface_global(){
	cli_iface=${1}
    get_cli_iface_json "${cli_iface}" | jq '.global' | grep -q true
}

# ------------------------------------------------------------------------------------------
#
# Осуществляем пересоздание таблиц и правил при поднятии интерфейса
#
# ------------------------------------------------------------------------------------------
link_up(){
	ip4set_create_table
	ip4_add_route_table
	ip4_rule_set_priority
	ip4_mark_vpn_network
}

# ------------------------------------------------------------------------------------------
#
# Осуществляем очистку таблиц и правил при падении интерфейса
#
# ------------------------------------------------------------------------------------------
link_down(){
	ip4_firewall_flush_vpn_rules
	ip4_rule_del_priority
	ip4_flush_all_tables
}

# ------------------------------------------------------------------------------------------
#
# Осуществляем очистку и пересоздание таблиц и правил при перезагрузке интерфейса
#
# ------------------------------------------------------------------------------------------
link_reboot(){
	local connect_pause_time=5
	link_down
	# перезапускаем основное и vpn подключение в случае сбоя
	reset_connection "${1}" "${connect_pause_time}" && link_up || {
		# снова перезапускаем основное и vpn подключение
		reset_connection "${1}" "${connect_pause_time}" && link_up || {
			logger -t "КВАС" "Сбой в подключении ${1}!"
			exit 1
		}
	}
}

