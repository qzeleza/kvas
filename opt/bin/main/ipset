#!/bin/sh

. /opt/apps/kvas/bin/libs/ipset
logger -t "КВАС" "Запущен файл ${0}"

# Проверяем доступность сети
until ADDRS=$(kdig +short ya.ru @127.0.0.1:9153 ) && [ -n "${ADDRS}" ] > /dev/null 2>&1; do sleep 5; done

# Подготавливаем список текущих адресов в ipset для проверки
current_ipset=$(ipset list "${TABLE_NAME}" | grep "^[0-9]")

# Обновляем таблицу ipset данными из файла
while read -r line || [ -n "${line}" ]; do
    [ "${line::1}" = "-" ] || [ -z "${line}" ] || [ "${line:0:1}" = "#" ] && continue
    line=$(echo "${line}" | sed 's/#.*$//g' | tr -s ' ' | sed 's/\*//g')

    # Обрабатываем IP, диапазоны IP и сети
    if echo "${line}" | grep -qE "${IP_FILTER}|${IP_FILTER}-${IP_FILTER}|${IP_FILTER}/[0-9]{1,2}"; then
        [[ ! $current_ipset =~ $line ]] && ipset -exist add "${TABLE_NAME}" "${line}"
    else
        add_host_by_iplist_to_ipset "${line}"
    fi
done < "${HOST_LIST}"